<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心结解开评估系统 - 找回内心平静</title>
    <style>
        /* 完整的独立CSS样式，不依赖外部字体 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-color: #2D6A6A;
            --primary-hover: #58A8A8;
            --primary-light: #E1F0F0;
            --bg-warm: #FCFBF8;
            --bg-surface: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --error-color: #DC3545;
            --font-heading: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            --space-xs: 8px;
            --space-sm: 16px;
            --space-md: 24px;
            --space-lg: 32px;
            --space-xl: 48px;
            --space-xxl: 64px;
            --space-xxxl: 96px;
            --border-radius: 12px;
            --shadow-card: 0 4px 12px rgba(45, 106, 106, 0.08);
            --shadow-button: 0 2px 4px rgba(0, 0, 0, 0.1);
            --transition-smooth: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-quick: all 0.2s ease-in-out;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-warm);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--space-lg);
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-xl);
            padding: var(--space-lg) 0;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: var(--space-sm);
            font-family: var(--font-heading);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .page-container {
            display: none;
            background: var(--bg-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
        }

        .page-container.active {
            display: block;
        }

        .intro-content {
            text-align: center;
        }

        .intro-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin: var(--space-xl) 0;
        }

        .feature-card {
            padding: var(--space-md);
            background: var(--primary-light);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .feature-card h3 {
            color: var(--primary-color);
            margin-bottom: var(--space-sm);
            font-size: 1.1rem;
        }

        .progress-bar {
            background: var(--border-color);
            border-radius: 20px;
            height: 8px;
            margin-bottom: var(--space-lg);
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-hover));
            height: 100%;
            width: 0%;
            transition: var(--transition-smooth);
            border-radius: 20px;
        }

        .question-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            position: relative;
        }

        .question-header {
            margin-bottom: var(--space-lg);
        }

        .question-number {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
        }

        .question-title {
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .dimension-tag {
            display: inline-block;
            background: var(--primary-light);
            color: var(--primary-color);
            padding: var(--space-xs) var(--space-sm);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .options-grid {
            display: grid;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: var(--space-sm);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition-quick);
            background: white;
        }

        .option-item:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .option-item.selected {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .option-item input[type="radio"] {
            margin-right: var(--space-sm);
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .option-item label {
            flex: 1;
            cursor: pointer;
            font-size: 1rem;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-lg);
        }

        .btn {
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-quick);
            font-family: var(--font-body);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .result-summary {
            text-align: center;
            margin-bottom: var(--space-xl);
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-lg);
            font-size: 3rem;
            font-weight: bold;
            position: relative;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            z-index: -1;
        }

        .score-description {
            font-size: 1.1rem;
            margin-bottom: var(--space-xl);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .result-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--space-lg);
        }

        .result-card h3 {
            color: var(--primary-color);
            margin-bottom: var(--space-md);
            font-size: 1.2rem;
        }

        .dimension-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .dimension-item:last-child {
            border-bottom: none;
        }

        .dimension-score {
            font-weight: 600;
            color: var(--primary-color);
        }

        .priority-list {
            list-style: none;
        }

        .priority-item {
            padding: var(--space-sm);
            margin-bottom: var(--space-sm);
            background: var(--primary-light);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .recommendations {
            background: var(--bg-warm);
            border-radius: var(--border-radius);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }

        .recommendations h3 {
            color: var(--primary-color);
            margin-bottom: var(--space-md);
        }

        .recommendation-item {
            margin-bottom: var(--space-sm);
            padding-left: var(--space-md);
            position: relative;
        }

        .recommendation-item::before {
            content: '•';
            color: var(--primary-color);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        .error-message {
            background: #fee;
            color: var(--error-color);
            padding: var(--space-md);
            border-radius: var(--border-radius);
            border: 1px solid var(--error-color);
            margin-bottom: var(--space-lg);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin: var(--space-lg) 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            position: relative;
        }

        .chart-fallback {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .manual-chart {
            width: 100%;
            height: 300px;
            position: relative;
            display: none;
        }

        .manual-chart.show {
            display: block;
        }

        .chart-text {
            position: absolute;
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-sm);
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .page-container {
                padding: var(--space-lg);
            }
            
            .navigation {
                flex-direction: column;
                gap: var(--space-sm);
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .question-title {
                font-size: 1.1rem;
            }
            
            .score-circle {
                width: 150px;
                height: 150px;
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>心结解开评估系统</h1>
            <p>通过科学的心理评估，帮助您了解内心创伤，找到治愈的方向</p>
        </header>

        <div id="error-message" class="error-message"></div>

        <!-- 介绍页面 -->
        <div id="intro-page" class="page-container active">
            <div class="intro-content">
                <h2 style="margin-bottom: var(--space-lg); color: var(--primary-color);">欢迎使用心结解开评估系统</h2>
                <p style="margin-bottom: var(--space-xl); font-size: 1.1rem; line-height: 1.8;">
                    这是一个专业的心理创伤评估工具，通过28道精心设计的题目，从7个维度全面评估您可能存在的心理创伤。
                    评估结果将为您提供个性化的建议和治愈方向。
                </p>
                
                <div class="intro-features">
                    <div class="feature-card">
                        <h3>科学评估</h3>
                        <p>基于专业心理学理论，结合实际创伤事件进行评估</p>
                    </div>
                    <div class="feature-card">
                        <h3>全面分析</h3>
                        <p>涵盖亲密关系、家庭、校园、职场等多个生活领域</p>
                    </div>
                    <div class="feature-card">
                        <h3>个性化建议</h3>
                        <p>根据您的具体情况，提供针对性的治愈建议</p>
                    </div>
                </div>
                
                <button onclick="startTest()" class="btn btn-primary" style="font-size: 1.1rem; padding: var(--space-md) var(--space-xl);">
                    开始评估
                </button>
            </div>
        </div>

        <!-- 测试页面 -->
        <div id="test-page" class="page-container">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            
            <div class="question-card">
                <div class="question-header">
                    <div class="question-number">
                        题目 <span id="current-question">1</span>/<span id="total-questions">28</span>
                    </div>
                    <h2 id="question-title" class="question-title"></h2>
                    <span id="dimension-tag" class="dimension-tag"></span>
                </div>
                
                <div id="question-options" class="options-grid"></div>
                
                <div class="navigation">
                    <button id="prev-btn" class="btn btn-secondary" onclick="previousQuestion()" disabled>
                        上一题
                    </button>
                    <button id="next-btn" class="btn btn-primary" onclick="nextQuestion()" disabled>
                        下一题
                    </button>
                </div>
            </div>
        </div>

        <!-- 结果页面 -->
        <div id="result-page" class="page-container">
            <div class="result-summary">
                <div class="score-circle">
                    <div>
                        <div id="overall-score">0</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">分</div>
                    </div>
                </div>
                <div id="score-description" class="score-description"></div>
            </div>
            
            <div class="chart-container">
                <div id="chart-canvas" class="chart-fallback">
                    <p style="color: var(--text-secondary);">雷达图加载中...</p>
                </div>
            </div>
            
            <div class="results-grid">
                <div class="result-card">
                    <h3>各维度得分</h3>
                    <div id="details-grid"></div>
                </div>
                
                <div class="result-card">
                    <h3>重点关注领域</h3>
                    <ul id="priority-list" class="priority-list"></ul>
                </div>
            </div>
            
            <div class="recommendations">
                <h3>个性化建议</h3>
                <div id="recommendations-content"></div>
            </div>
            
            <div style="text-align: center; margin-top: var(--space-xl);">
                <button onclick="downloadReport()" class="btn btn-primary" style="margin-right: var(--space-sm);">
                    下载评估报告
                </button>
                <button onclick="restartTest()" class="btn btn-secondary">
                    重新评估
                </button>
            </div>
        </div>
    </div>

    <script>
        // 创伤评估数据和配置
        const traumaData = {
            dimensions: [
                { id: 'intimate', name: '亲密关系破裂', maxScore: 12 },
                { id: 'family', name: '亲子关系冲突', maxScore: 12 },
                { id: 'loss', name: '重要亲人离世', maxScore: 12 },
                { id: 'friendship', name: '朋友反目成仇', maxScore: 12 },
                { id: 'failure', name: '重大选择失败', maxScore: 12 },
                { id: 'childhood', name: '童年阴影创伤', maxScore: 12 },
                { id: 'humiliation', name: '公开受辱经历', maxScore: 12 }
            ],
            questions: [
                // 亲密关系破裂
                { dimension: 'intimate', text: '您是否经历过伴侣的出轨或背叛，让您对感情产生怀疑和不信任？' },
                { dimension: 'intimate', text: '您是否因为分手或离婚而感到深深的痛苦和失落？' },
                { dimension: 'intimate', text: '您是否被至亲至爱的人欺瞒过，感到被背叛和伤害？' },
                { dimension: 'intimate', text: '您是否经历过被威胁或控制的亲密关系？' },
                
                // 亲子关系冲突
                { dimension: 'family', text: '您是否经历过父母的抛弃或被拐骗等童年创伤事件？' },
                { dimension: 'family', text: '您是否目睹或经历家庭暴力事件而感到恐惧和不安？' },
                { dimension: 'family', text: '您是否因为遭受性侵或猥亵而留下心理阴影？' },
                { dimension: 'family', text: '您是否因为身体残缺而无法正视自己？' },
                
                // 重要亲人离世
                { dimension: 'loss', text: '您是否经历过至亲离世，长期无法走出悲伤？' },
                { dimension: 'loss', text: '您是否因为错过重要的人或事而留下永久的遗憾？' },
                { dimension: 'loss', text: '您是否因为宠物死亡而长期陷入哀伤？' },
                { dimension: 'loss', text: '您是否因为重要关系突然断裂而感到空虚和迷茫？' },
                
                // 朋友反目成仇
                { dimension: 'friendship', text: '您是否经历过与朋友反目成仇的痛苦？' },
                { dimension: 'friendship', text: '您是否因为被朋友利用或窃取成果而感到愤怒？' },
                { dimension: 'friendship', text: '您是否因为友谊破裂而对他人失去信任？' },
                { dimension: 'friendship', text: '您是否因为社交失败而感到孤独和被排斥？' },
                
                // 重大选择失败
                { dimension: 'failure', text: '您是否因为重大选择失误而改变人生轨迹？' },
                { dimension: 'failure', text: '您是否因为被迫放弃学业或梦想而感到遗憾？' },
                { dimension: 'failure', text: '您是否因为投资失败或被骗而承受经济压力？' },
                { dimension: 'failure', text: '您是否因为重大过失（如车祸/监护过失）而长期自责？' },
                
                // 童年阴影创伤
                { dimension: 'childhood', text: '您是否经历过当众被羞辱或嘲笑的事件？' },
                { dimension: 'childhood', text: '您是否因为童年创伤而对权威人物产生恐惧？' },
                { dimension: 'childhood', text: '您是否因为童年阴影而影响成年后的自我认知？' },
                { dimension: 'childhood', text: '您是否因为早期创伤而对安全感缺失？' },
                
                // 公开受辱经历
                { dimension: 'humiliation', text: '您是否经历过重要场合出丑的尴尬事件？' },
                { dimension: 'humiliation', text: '您是否因为表白被嘲弄拒绝而对感情产生恐惧？' },
                { dimension: 'humiliation', text: '您是否因为被PUA而对自己的价值产生怀疑？' },
                { dimension: 'humiliation', text: '您是否因为公开受辱而长期逃避社交场合？' }
            ],
            options: [
                { value: 0, text: '从未经历过' },
                { value: 1, text: '偶尔想起时会有些不舒服' },
                { value: 2, text: '经常想起并感到困扰' },
                { value: 3, text: '严重影响日常生活' }
            ],
            recommendations: {
                intimate: [
                    '建议寻求专业心理咨询，建立健康的亲密关系模式',
                    '可以尝试参加情感支持小组，与有相似经历的人交流',
                    '学会建立边界，保护自己的情感安全'
                ],
                family: [
                    '考虑家庭治疗，改善亲子关系',
                    '寻求专业帮助处理童年创伤',
                    '学习自我关爱，重建安全感'
                ],
                loss: [
                    '允许自己悲伤，接受失去是人生的一部分',
                    '考虑参加哀伤辅导或支持小组',
                    '通过纪念活动或创作表达情感'
                ],
                friendship: [
                    '学会识别真诚的友谊，避免有毒关系',
                    '主动建立新的健康友谊关系',
                    '提升社交技能，重建对人的信任'
                ],
                failure: [
                    '接受失败是成长的一部分，不要过度自责',
                    '分析失败原因，制定新的计划和目标',
                    '寻求导师或教练的帮助和指导'
                ],
                childhood: [
                    '寻求专业心理咨询处理童年创伤',
                    '学习自我安抚技巧，重建安全感',
                    '通过正念冥想等方式疗愈内心'
                ],
                humiliation: [
                    '学习自信建立技巧，提升自我价值感',
                    '练习社交技能，逐步重建社交信心',
                    '寻求支持，避免孤立自己'
                ]
            }
        };

        // 全局变量
        let currentQuestionIndex = 0;
        let answers = {};
        let testCompleted = false;
        let chartInstance = null;

        // DOM元素
        const elements = {
            introPage: document.getElementById('intro-page'),
            testPage: document.getElementById('test-page'),
            resultPage: document.getElementById('result-page'),
            progressFill: document.getElementById('progress-fill'),
            currentQuestionSpan: document.getElementById('current-question'),
            totalQuestionsSpan: document.getElementById('total-questions'),
            questionTitle: document.getElementById('question-title'),
            questionOptions: document.getElementById('question-options'),
            dimensionTag: document.getElementById('dimension-tag'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            overallScore: document.getElementById('overall-score'),
            scoreDescription: document.getElementById('score-description'),
            detailsGrid: document.getElementById('details-grid'),
            priorityList: document.getElementById('priority-list'),
            recommendationsContent: document.getElementById('recommendations-content'),
            errorMessage: document.getElementById('error-message')
        };

        // 工具函数
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.add('show');
            setTimeout(() => {
                elements.errorMessage.classList.remove('show');
            }, 5000);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page-container').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + '-page').classList.add('active');
        }

        function getAllQuestions() {
            return traumaData.questions;
        }

        function initTest() {
            try {
                const allQuestions = getAllQuestions();
                elements.totalQuestionsSpan.textContent = allQuestions.length;
                currentQuestionIndex = 0;
                answers = {};
                testCompleted = false;
                console.log('Test initialized with', allQuestions.length, 'questions');
            } catch (error) {
                showError('初始化测试时出错：' + error.message);
            }
        }

        // 开始测试
        function startTest() {
            try {
                console.log('Starting test...');
                showPage('test');
                loadQuestion();
            } catch (error) {
                showError('开始测试时出错：' + error.message);
            }
        }

        // 加载题目
        function loadQuestion() {
            try {
                const allQuestions = getAllQuestions();
                if (currentQuestionIndex >= allQuestions.length) {
                    completeTest();
                    return;
                }

                const question = allQuestions[currentQuestionIndex];
                const dimension = traumaData.dimensions.find(d => d.id === question.dimension);
                
                // 更新题目内容
                elements.questionTitle.textContent = question.text;
                elements.dimensionTag.textContent = dimension.name;
                elements.currentQuestionSpan.textContent = currentQuestionIndex + 1;
                
                // 更新进度条
                const progress = ((currentQuestionIndex) / allQuestions.length) * 100;
                elements.progressFill.style.width = progress + '%';
                
                // 生成选项
                generateOptions(question);
                
                // 更新按钮状态
                updateNavigationButtons();
                
                console.log('Question loaded:', currentQuestionIndex + 1, '/', allQuestions.length);
            } catch (error) {
                showError('加载题目时出错：' + error.message);
            }
        }

        // 生成选项
        function generateOptions(question) {
            try {
                elements.questionOptions.innerHTML = '';
                
                traumaData.options.forEach((option, index) => {
                    const optionId = `q${currentQuestionIndex}_opt${index}`;
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item';
                    
                    const isChecked = answers[currentQuestionIndex] === option.value;
                    if (isChecked) {
                        optionDiv.classList.add('selected');
                    }
                    
                    optionDiv.innerHTML = `
                        <input type="radio" 
                               id="${optionId}" 
                               name="question_${currentQuestionIndex}" 
                               value="${option.value}"
                               ${isChecked ? 'checked' : ''}
                               onchange="selectOption(${option.value})">
                        <label for="${optionId}">${option.text}</label>
                    `;
                    
                    elements.questionOptions.appendChild(optionDiv);
                });
            } catch (error) {
                showError('生成选项时出错：' + error.message);
            }
        }

        // 选择选项
        function selectOption(value) {
            try {
                answers[currentQuestionIndex] = parseInt(value);
                console.log('Answer selected:', currentQuestionIndex, value);
                
                // 更新选项样式
                document.querySelectorAll('.option-item').forEach((item, index) => {
                    item.classList.remove('selected');
                    const radio = item.querySelector('input[type="radio"]');
                    if (radio && parseInt(radio.value) === value) {
                        item.classList.add('selected');
                    }
                });
                
                updateNavigationButtons();
            } catch (error) {
                showError('选择选项时出错：' + error.message);
            }
        }

        // 更新导航按钮
        function updateNavigationButtons() {
            const hasAnswer = answers[currentQuestionIndex] !== undefined;
            elements.nextBtn.disabled = !hasAnswer;
            elements.prevBtn.disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === getAllQuestions().length - 1 && hasAnswer) {
                elements.nextBtn.textContent = '完成评估';
            } else {
                elements.nextBtn.textContent = '下一题';
            }
        }

        // 下一题
        function nextQuestion() {
            try {
                if (answers[currentQuestionIndex] === undefined) {
                    showError('请选择一个答案后再继续');
                    return;
                }
                
                currentQuestionIndex++;
                loadQuestion();
            } catch (error) {
                showError('下一题时出错：' + error.message);
            }
        }

        // 上一题
        function previousQuestion() {
            try {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    loadQuestion();
                }
            } catch (error) {
                showError('上一题时出错：' + error.message);
            }
        }

        // 完成测试
        function completeTest() {
            try {
                testCompleted = true;
                console.log('Test completed, calculating results...');
                calculateResults();
                showPage('result');
            } catch (error) {
                showError('完成测试时出错：' + error.message);
            }
        }

        // 计算结果
        function calculateResults() {
            try {
                const allQuestions = getAllQuestions();
                const dimensionScores = {};
                
                // 初始化维度得分
                traumaData.dimensions.forEach(dimension => {
                    dimensionScores[dimension.id] = 0;
                });
                
                // 计算每个维度的得分
                allQuestions.forEach((question, index) => {
                    const answer = answers[index] || 0;
                    dimensionScores[question.dimension] += answer;
                });
                
                // 计算总分
                let totalScore = 0;
                Object.values(dimensionScores).forEach(score => {
                    totalScore += score;
                });
                
                // 生成结果
                displayResults(totalScore, dimensionScores);
            } catch (error) {
                showError('计算结果时出错：' + error.message);
            }
        }

        // 显示结果
        function displayResults(totalScore, dimensionScores) {
            try {
                // 显示总分
                elements.overallScore.textContent = totalScore;
                elements.scoreDescription.textContent = getScoreDescription(totalScore);
                
                // 显示各维度得分
                displayDimensionScores(dimensionScores);
                
                // 显示重点关注领域
                displayPriorityAreas(dimensionScores);
                
                // 显示建议
                displayRecommendations(dimensionScores);
                
                // 创建雷达图
                createRadarChart(dimensionScores);
            } catch (error) {
                showError('显示结果时出错：' + error.message);
            }
        }

        // 获取分数描述
        function getScoreDescription(score) {
            if (score <= 20) {
                return '您的心结困扰程度较低，这表明您在处理情感创伤方面表现良好。请继续保持积极的心态。';
            } else if (score <= 40) {
                return '您存在一定的心结困扰，建议关注自己的情感需求，适时寻求支持和帮助。';
            } else if (score <= 60) {
                return '您的心结困扰较为明显，建议认真对待，寻求专业心理咨询师的帮助。';
            } else if (score <= 80) {
                return '您的心结困扰严重，建议尽快寻求专业心理治疗，这可能会对您的日常生活产生较大影响。';
            } else {
                return '您的心结困扰非常严重，强烈建议立即寻求专业心理治疗，不要独自承受。';
            }
        }

        // 显示维度得分
        function displayDimensionScores(dimensionScores) {
            elements.detailsGrid.innerHTML = '';
            
            traumaData.dimensions.forEach(dimension => {
                const score = dimensionScores[dimension.id];
                const percentage = Math.round((score / dimension.maxScore) * 100);
                
                const item = document.createElement('div');
                item.className = 'dimension-item';
                item.innerHTML = `
                    <span>${dimension.name}</span>
                    <span class="dimension-score">${score}/${dimension.maxScore} (${percentage}%)</span>
                `;
                elements.detailsGrid.appendChild(item);
            });
        }

        // 显示重点关注领域
        function displayPriorityAreas(dimensionScores) {
            elements.priorityList.innerHTML = '';
            
            // 按得分排序
            const sortedDimensions = traumaData.dimensions
                .map(dimension => ({
                    ...dimension,
                    score: dimensionScores[dimension.id]
                }))
                .sort((a, b) => b.score - a.score)
                .slice(0, 3); // 取前3个得分最高的维度
            
            sortedDimensions.forEach(dimension => {
                const li = document.createElement('li');
                li.className = 'priority-item';
                li.innerHTML = `
                    <strong>${dimension.name}</strong> (得分: ${dimension.score}/${dimension.maxScore})
                    <br>建议重点关注这个领域的治愈工作
                `;
                elements.priorityList.appendChild(li);
            });
        }

        // 显示建议
        function displayRecommendations(dimensionScores) {
            elements.recommendationsContent.innerHTML = '';
            
            traumaData.dimensions.forEach(dimension => {
                const score = dimensionScores[dimension.id];
                if (score > 0) { // 只显示有得分的维度的建议
                    const recs = traumaData.recommendations[dimension.id] || [];
                    if (recs.length > 0) {
                        const recSection = document.createElement('div');
                        recSection.style.marginBottom = 'var(--space-lg)';
                        recSection.innerHTML = `
                            <h4 style="color: var(--primary-color); margin-bottom: var(--space-sm);">
                                ${dimension.name}相关建议：
                            </h4>
                        `;
                        
                        recs.forEach(rec => {
                            const recItem = document.createElement('div');
                            recItem.className = 'recommendation-item';
                            recItem.textContent = rec;
                            recSection.appendChild(recItem);
                        });
                        
                        elements.recommendationsContent.appendChild(recSection);
                    }
                }
            });
        }

        // 创建雷达图
        function createRadarChart(dimensionScores) {
            try {
                const canvas = document.getElementById('chart-canvas');
                canvas.innerHTML = '';
                
                // 创建雷达图的替代显示 - 使用纯CSS和HTML实现
                const chartDiv = document.createElement('div');
                chartDiv.style.cssText = 'width: 100%; max-width: 400px; margin: 0 auto;';
                
                let chartHTML = '<h4 style="margin-bottom: 24px; color: var(--primary-color); text-align: center;">各维度创伤程度分析</h4>';
                
                traumaData.dimensions.forEach(dimension => {
                    const score = dimensionScores[dimension.id];
                    const percentage = Math.round((score / dimension.maxScore) * 100);
                    const barHeight = Math.max(percentage * 2, 8); // 最小8px高度
                    
                    chartHTML += `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">${dimension.name}</span>
                                <span style="font-size: 0.9rem; color: var(--primary-color); font-weight: 600;">${percentage}%</span>
                            </div>
                            <div style="width: 100%; height: 12px; background: var(--border-color); border-radius: 6px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--primary-hover)); border-radius: 6px; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                    `;
                });
                
                chartHTML += '<p style="margin-top: 20px; font-size: 0.85rem; color: var(--text-secondary); text-align: center; padding: 12px; background: var(--primary-light); border-radius: 8px;">百分比越高表示该维度创伤影响越明显</p>';
                
                chartDiv.innerHTML = chartHTML;
                canvas.appendChild(chartDiv);
                
                console.log('Alternative radar chart created successfully');
            } catch (error) {
                console.error('Error creating chart:', error);
                showError('创建图表时出错：' + error.message);
            }
        }

        // 下载报告
        function downloadReport() {
            try {
                const reportData = {
                    timestamp: new Date().toISOString(),
                    overallScore: parseInt(elements.overallScore.textContent),
                    scoreDescription: elements.scoreDescription.textContent,
                    answers: answers,
                    dimensionScores: getDimensionScores(),
                    recommendations: getRecommendations()
                };
                
                const dataStr = JSON.stringify(reportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `心结评估报告_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
                link.click();
                
                alert('报告已下载为JSON文件。如需更详细的分析和建议，建议咨询专业心理倾听与成长服务。');
            } catch (error) {
                showError('下载报告时出错：' + error.message);
            }
        }

        function getDimensionScores() {
            const dimensionScores = {};
            traumaData.dimensions.forEach(dimension => {
                dimensionScores[dimension.id] = 0;
            });
            
            const allQuestions = getAllQuestions();
            allQuestions.forEach((question, index) => {
                const answer = answers[index] || 0;
                dimensionScores[question.dimension] += answer;
            });
            
            return dimensionScores;
        }

        function getRecommendations() {
            const recommendations = [];
            const dimensionScores = getDimensionScores();
            
            traumaData.dimensions.forEach(dimension => {
                const score = dimensionScores[dimension.id];
                if (score > 0) {
                    recommendations.push({
                        dimension: dimension.name,
                        score: score,
                        suggestions: traumaData.recommendations[dimension.id] || []
                    });
                }
            });
            
            return recommendations;
        }

        // 重新开始测试
        function restartTest() {
            try {
                console.log('Restarting test...');
                initTest();
                showPage('intro');
            } catch (error) {
                showError('重新开始时出错：' + error.message);
            }
        }

        // 键盘导航
        document.addEventListener('keydown', function(e) {
            if (elements.testPage.classList.contains('active')) {
                if (e.key === 'ArrowRight' || e.key === ' ') {
                    e.preventDefault();
                    if (!elements.nextBtn.disabled) nextQuestion();
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    if (!elements.prevBtn.disabled) previousQuestion();
                }
            }
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('DOM loaded, initializing application...');
                initTest();
                console.log('Application initialized successfully');
            } catch (error) {
                showError('初始化应用时出错：' + error.message);
            }
        });
    </script>
</body>
</html>